
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>登录注册</title>          
    <link rel="stylesheet" href="css/login.css"> 
    <link rel="stylesheet" href="css/header.css">
    <link rel="stylesheet" href="css/bootstrap.css"/>
    <script src="js/jquery.min.js"></script>
    <script src="js/popper.min.js"></script>
    <script src="js/bootstrap.min.js"></script>
    <style>
        body{
            background-color: #272624;
        }    
        .active{color: #ffe401 !important;}
    </style>          
</head>
<body>
    <div id="login_h">
            <img src="img/b1.jpg" alt="">
            <div class="header mb-5" >
                    <header id="header">
                            <div>
                                <ul class="dropdown-li" >
                                    <li class="dropdown "><a href="index.html" class="aaa">首页</a></li>
                                    <li class="dropdown "><a href="index01.html" class="aaa">关于我们</a></li>
                                    <li class="dropdown ">
                                        <a data-trigger="dropdown" href="index02.html" class="aaa">新闻动态</a>
                                        <ul class="dropdown-menu">
                                            <li><a href="Javascript:;">公司新闻</a></li>
                                            <li><a href="Javascript:;">行业新闻</a></li>
                                        </ul>
                                    </li>
                                    <li class="dropdown">
                                        <a data-trigger="dropdown" href="index03.html" class="aaa">案例展示</a>
                                        <ul class="dropdown-menu">
                                            <li>
                                                <a href="index03_01.html">现代风格</a>
                                            </li>
                                            <li>
                                               <a href="index03_02.html">欧式风格</a>
                                            </li>
                                            <li>
                                                <a href="index03_03.html">阳台风格</a>
                                            </li>
                                            <li>
                                                <a href="index03_04.html">中式风格</a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="dropdown"><a href="index05.html" class="aaa">公益服务</a></li>
                                    <li class="dropdown"><a href="index04.html" class="aaa">设计团队</a></li>
                                    <li class="dropdown"><a href="index06.html" class="aaa">联系我们</a></li>
                                </ul>
                            </div>
                        </header>
               <div>
                    <div class="where">
                        <a href="#" class="mycolor" id="header_login" style="text-align:right;"></a>/
                        <a href="#" class="mycolor" id="header_reg" style="text-align:left;"></a>
                    </div>
                </div> 
            </div>
            <div id="tbody">
                <div class="container">
                    <div class="row">
                        <!-- 登陆框 -->
                        <div class="login col-4  offset-8 text-center mt-5">
                            <h2 class="mt-5"><a href="#" class="list-unstyled mycolor">账号密码登陆</a></h2>
                            <div class="mt-5 ">
                                <p >
                                <input type="text" placeholder="请输入账号" maxlength="8" class="u pl-3" id="login_uname"/>
                                <span id="spn1"></span>
                                </p>
                                <!-- <div id="ts"></div> -->
                                <p>
                                <input type="password" placeholder="请输入密码" maxlength="8" class="u pl-3" id="login_upwd"/>
                                <span id="spn2"></span>
                                </p>
                                <!-- <div id="ts1"></div> -->
                                <div id="test" class="mb-3">
                                    <input type="text" class="pl-3" placeholder="验证码">
                                    <span>
                                      <canvas id="canvas" width="149" height="50"></canvas>
                                    </span>
                                    <button class="change">换一张</button>
                                    <span id="spn7"></span>
                                </div>
                                <p>
                                    <input type="button"  class="btn pl-3" id="login_btn" value="登陆"/>
                                    <span id="spn6"></span>
                                </p>
                                <div class="forget mb-5">
                                    <div>
                                        <input type="checkbox" id="rember"><label for="rember">记住密码</label>
                                    </div>
                                    <div>
                                       <a href="#" class="mycolor">忘记密码</a>
                                       <a href="#" class="mycolor ml-3" id="login_reg">去注册</a>
                                    </div>
                                </div >
                            </div>
                        </div>
                        <!-- 注册框 -->
                        <div class="reg col-4  offset-8 text-center mt-5">
                                <!-- <div id="ts2"></div>
                                <div id="ts3"></div>
                                <div id="ts4"></div> -->
                                <h2 class="mt-5"><a href="#" class="list-unstyled mycolor">用户注册</a></h2>
                                <div class="mt-5">
                                    <p >
                                    <input type="text" placeholder="请输入账号" maxlength="8" class="u pl-3"  id="reg_uname"/>
                                    <span id="spn3"></span>
                                    </p>
                                   
                                    <p>
                                    <input type="password" placeholder="请输入用户密码" maxlength="8" class="u pl-3" id="reg_upwd"/>
                                    <span id="spn4"></span>
                                    </p>
                                   
                                    <p >
                                    <input type="text" placeholder="请输入手机号" maxlength="11" class="u pl-3" id="phone"/>
                                    <span id="spn5"></span>
                                    </p>
                                    
                                    <p><input type="button"  class="btn pl-3" id="reg_btn" value="注册"/>
                                        <span id="spn8"></span>
                                    </p>
                                    <p><input type="button"  class="btn pl-3" id="reg_login" value="直接去登陆"/></p>
                                    <div class="forget mb-5">
                                </div>
                                </div>
                        </div>
                    </div>
                </div>               
            </div>
            <!-- 底脚 -->
        <div id="al-foot" style="margin-top: 150px">
            <a href="#"><img src="img/top.png" alt=""></a>
            <p>Copyright © 2019 版权所有 备案号：ICP备XXXXXXXX号 技术支持</p>
        </div>
    </div>
            <script>

                var login=document.querySelector(".login");
                var reg=document.querySelector(".reg");
                var login_reg=document.getElementById("login_reg");
                var reg_login=document.getElementById("reg_login");
                var header_login=document.getElementById("header_login");
                var header_reg=document.getElementById("header_reg");
                var reg1=/^[a-z0-9_]{3,8}$/i;
                // 获取去地址栏=后面的信息
                var id=location.search.split('=')[1];
                // console.log(id);
                if(id==1){
                    login.style.display="block";
                    reg.style.display="none";
                }else if(id==2){
                    login.style.display="none";
                    reg.style.display="block";
                }
                // 登录
                $("#login_uname").blur(function(){
                   var u=$(this).val();
                    if(!reg1.test(u)){
                        $(this).val("");
                        spn1.innerHTML=("账号长度必须在3-8位之间");
                        return; 
                    }
                });
                $("#login_upwd").blur(function(){
                   var u=$(this).val();
                    if(!reg1.test(u)){
                        $(this).val("");
                        spn2.innerHTML=("密码长度必须在3-8位之间");
                        return; 
                    }
                });
                // 注册
                $("#reg_uname").blur(function(){
                   var u=$(this).val();
                    if(!reg1.test(u)){
                        $(this).val("");
                        spn3.innerHTML=("注册账号长度必须在3-8位之间")
                        return; 
                    }
                });
                $("#reg_upwd").blur(function(){
                   var u=$(this).val();
                    if(!reg1.test(u)){
                        $(this).val("");
                        spn4.innerHTML=("密码长度必须在3-8位之间")
                        return; 
                    }
                });
                
                $("#phone").blur(function(){
                    var regg=/^1[3-8]\d{9}$/
                   var u=$(this).val();
                    if(!regg.test(u)){
                        $(this).val("");
                        spn5.innerHTML=("手机号长度必须为11位")
                        return; 
                    }
                });
                login_reg.onclick=function(){
                    login.style.display="none";
                    reg.style.display="block";
                }
                reg_login.onclick=function(){
                    login.style.display="block";
                    reg.style.display="none";
                }
                header_login.onclick=function(){
                    login.style.display="block";
                    reg.style.display="none";
                }
                header_reg.onclick=function(){
                    login.style.display="none";
                    reg.style.display="block";
                }   
                //获取验证码
                var canvas=document.getElementById("canvas");
                var ctx=canvas.getContext("2d");
                var change=document.getElementsByClassName("change")[0];
                var str=test(ctx);
                // 通过点击 再次调用封装函数
                change.onclick=function(){
                    ctx.clearRect(0,0,149,50)
                    str=test(ctx)
                    
                }  
                //验证码  封装函数
                function test(ctx){
                    
                    ctx.textBaseline="top";
                    var  str="";
                    for(var i=0;i<4;i++){
                        var a1=parseInt(Math.random()*10);
                        var x=parseInt(Math.random()*20)+35*i;
                        var y=parseInt(Math.random()*20);
                        var r=Math.random()*256;
                        var g=Math.random()*256;
                        var b=Math.random()*256;
                        ctx.fillStyle=`rgba(${r},${g},${b})`;
                        ctx.font="45px SimHei";
                        ctx.fillText(a1,x,y)
                        str+=a1;
                        console.log(str)
                    }
                    for(var i=0;i<20;i++){
                        var startX=parseInt(Math.random()*149);
                        var startY=parseInt(Math.random()*70);
                        var endX=parseInt(Math.random()*149);
                        var endY=parseInt(Math.random()*70);
                        var lineWidth=parseInt(Math.random()*2);
                        ctx.beginPath();
                        ctx.moveTo(startX,startY);
                        ctx.lineTo(endX,endY);
                        ctx.closePath(); var r=Math.random()*256;
                        var g=Math.random()*256;
                        var b=Math.random()*256;
                        ctx.strokeStyle=`rgba(${r},${g},${b})`;
                        ctx.stroke();
                    }
                    return str
                }               
                //注册
                $("#reg_btn").click(function(){
                    var reg_uname=$("#reg_uname").val();
                    var reg_upwd=$("#reg_upwd").val();
                    var phone=$("#phone").val();
                    $.ajax({
                        url:"http://127.0.0.1:3000/user/reg",
                        type:"post",
                        data:{
                            uname:reg_uname,
                            upwd:reg_upwd,
                            phone:phone,                           
                        },
                        dataType:"json"
                    }).then(function(result){
                        console.log(result);
                        if(result.code!=200){
                           spn8.innerHTML=("请完善信息，将信息补充完整")
                            return;
                        }else{
                            alert("注册成功")
                            login.style.display="block";
                            reg.style.display="none";
                            // return;
                        }
                    });
                });
                //登陆
                $("#login_btn").click(function(){
                    var login_uname=$("#login_uname").val();
                    var login_upwd=$("#login_upwd").val();
                    var test=$("#test input").val();
                    if(login_uname==''||login_upwd==''){
                        spn6.innerHTML=("请输入账户或密码") 
                        return; 
                    }
                    else{
                        if(test==""){
                            spn7.innerHTML=("请输入验证码")
                            return;
                        }else if(test==str){
                            console.log(1)
                            $.ajax({
                                url:"http://127.0.0.1:3000/user/login",
                                type:"post",
                                data:{
                                    uname:login_uname,
                                    upwd:login_upwd
                                },
                                dataType:"json",
                                success:function(result){
                                    console.log(result)
                                    if(result.code==301){
                                        spn6.innerHTML=("账户或密码错误")
                                        return;
                                    }else{
                                        
                                        console.log(111)
                                        window.location.href=`index.html?uname=${login_uname}`
                                    }
                                }
                            })
                        }else{
                          alert("验证码不正确");
                          window.location.href="login.html"
                          test(ctx);
                        }       
                    }                   
                });
            </script>
        </body>
        </html>
